#!/usr/bin/env python3
\"\"\"\nCreate WACZ (Web Archive Collection Zipped) package\nOptimized for distribution and playback\n\"\"\"\n\nimport zipfile\nimport json\nimport sqlite3\nfrom pathlib import Path\nimport sys\nfrom datetime import datetime\n\ndef create_wacz(db_path: str, wacz_output: str):\n    \"\"\"Create WACZ package from SQLite archive\"\"\"\n    \n    db = Path(db_path)\n    if not db.exists():\n        print(f\"Error: Database not found: {db_path}\")\n        sys.exit(1)\n    \n    with zipfile.ZipFile(wacz_output, 'w', zipfile.ZIP_DEFLATED) as z:\n        # 1. Create datapackage.json (WACZ metadata)\n        datapackage = create_datapackage(db_path)\n        z.writestr('datapackage.json', json.dumps(datapackage, indent=2))\n        \n        # 2. Create CDX index\n        cdx_data = generate_cdx_index(db_path)\n        z.writestr('archive.cdx', cdx_data)\n        \n        # 3. Create catalog.json\n        catalog = generate_catalog(db_path)\n        z.writestr('catalog.json', json.dumps(catalog, indent=2))\n        \n        # 4. Create index.html for browser playback\n        index_html = generate_index_html(db_path)\n        z.writestr('index.html', index_html)\n        \n        # 5. Add metadata\n        metadata = generate_metadata(db_path)\n        z.writestr('metadata.json', json.dumps(metadata, indent=2))\n    \n    size_mb = Path(wacz_output).stat().st_size / 1024 / 1024\n    print(f\"\\u2705 Created WACZ package:\")\n    print(f\"  File: {wacz_output}\")\n    print(f\"  Size: {size_mb:.2f} MB\")\n    print(f\"  Format: WACZ 1.1.0\")\n    print(f\"  Playback: archiveweb.page\")\n\ndef create_datapackage(db_path: str) -> dict:\n    \"\"\"WACZ datapackage.json\"\"\"\n    conn = sqlite3.connect(db_path)\n    cursor = conn.cursor()\n    \n    cursor.execute('SELECT COUNT(*) FROM pages')\n    page_count = cursor.fetchone()[0]\n    \n    cursor.execute('SELECT COUNT(*) FROM assets')\n    asset_count = cursor.fetchone()[0]\n    \n    cursor.execute('SELECT value FROM metadata WHERE key = \"archived_at\" LIMIT 1')\n    archived_at = cursor.fetchone()\n    \n    conn.close()\n    \n    return {\n        \"profile\": \"data-package\",\n        \"resources\": [\n            {\n                \"name\": \"archive\",\n                \"type\": \"file\",\n                \"path\": \"archive/\",\n                \"title\": \"Web Archive\",\n                \"hash\": \"sha256:0000000000000000000000000000000000000000\"\n            }\n        ],\n        \"created\": datetime.utcnow().isoformat() + \"Z\",\n        \"title\": f\"Web Archive ({page_count} pages, {asset_count} assets)\",\n        \"description\": \"Web archive created with SmartArchiver\",\n        \"homepage\": \"https://archiveweb.page\",\n        \"version\": \"1.1.0\"\n    }\n\ndef generate_cdx_index(db_path: str) -> str:\n    \"\"\"Generate CDX index for fast lookups\"\"\"\n    conn = sqlite3.connect(db_path)\n    cursor = conn.cursor()\n    \n    # CDX header\n    cdx_lines = ['# CDX 1.0']\n    cdx_lines.append('# timestamp uri statuscode mime-type offset filename')\n    \n    cursor.execute('''\n        SELECT timestamp, uri, 200, mime_type, 0, 'archive.warc.gz'\n        FROM cdx\n        JOIN assets ON cdx.uri = assets.url\n        ORDER BY timestamp\n        LIMIT 1000\n    ''')\n    \n    for row in cursor.fetchall():\n        cdx_lines.append(' '.join(str(x) or '-' for x in row))\n    \n    conn.close()\n    return '\\n'.join(cdx_lines)\n\ndef generate_catalog(db_path: str) -> dict:\n    \"\"\"Generate WACZ catalog\"\"\"\n    conn = sqlite3.connect(db_path)\n    cursor = conn.cursor()\n    \n    cursor.execute('SELECT url, title FROM pages LIMIT 20')\n    pages = [{'url': p[0], 'title': p[1]} for p in cursor.fetchall()]\n    \n    cursor.execute('SELECT COUNT(*) FROM pages')\n    total_pages = cursor.fetchone()[0]\n    \n    cursor.execute('SELECT COUNT(*) FROM assets')\n    total_assets = cursor.fetchone()[0]\n    \n    conn.close()\n    \n    return {\n        \"title\": \"Web Archive Catalog\",\n        \"totalPages\": total_pages,\n        \"totalAssets\": total_assets,\n        \"pages\": pages,\n        \"created\": datetime.utcnow().isoformat() + \"Z\"\n    }\n\ndef generate_index_html(db_path: str) -> str:\n    \"\"\"Generate browser-playable index.html\"\"\"\n    conn = sqlite3.connect(db_path)\n    cursor = conn.cursor()\n    \n    cursor.execute('SELECT COUNT(*) FROM pages')\n    pages = cursor.fetchone()[0]\n    \n    cursor.execute('SELECT COUNT(*) FROM assets')\n    assets = cursor.fetchone()[0]\n    \n    cursor.execute('SELECT url FROM pages LIMIT 5')\n    sample_pages = [p[0] for p in cursor.fetchall()]\n    \n    conn.close()\n    \n    pages_html = '\\n'.join(f'<li><a href=\"#{url}\">{url}</a></li>' for url in sample_pages)\n    \n    return f\"\"\"<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"utf-8\">\n  <title>Web Archive Index</title>\n  <style>\n    body {{ font-family: sans-serif; margin: 20px; }}\n    .info {{ background: #f0f0f0; padding: 10px; margin: 10px 0; }}\n  </style>\n</head>\n<body>\n  <h1>Web Archive</h1>\n  <div class=\"info\">\n    <p><strong>Pages:</strong> {pages}</p>\n    <p><strong>Assets:</strong> {assets}</p>\n    <p><strong>Format:</strong> WACZ 1.1.0</p>\n    <p><strong>Created:</strong> {datetime.now().isoformat()}</p>\n  </div>\n  <h2>Sample Pages</h2>\n  <ul>\n    {pages_html}\n  </ul>\n  <p><em>Use <a href=\"https://archiveweb.page\">archiveweb.page</a> to browse this archive</em></p>\n</body>\n</html>\n\"\"\"\n\ndef generate_metadata(db_path: str) -> dict:\n    \"\"\"Generate metadata JSON\"\"\"\n    conn = sqlite3.connect(db_path)\n    cursor = conn.cursor()\n    \n    cursor.execute('SELECT key, value FROM metadata')\n    metadata = {row[0]: row[1] for row in cursor.fetchall()}\n    \n    conn.close()\n    \n    return {\n        \"archiver\": \"SmartArchiver/2.0\",\n        \"format\": \"WACZ\",\n        \"version\": \"1.1.0\",\n        \"conformsTo\": \"https://specs.webrecorder.net/wacz/1.1.1/\",\n        \"metadata\": metadata,\n        \"created\": datetime.utcnow().isoformat() + \"Z\"\n    }\n\nif __name__ == '__main__':\n    db_path = sys.argv[1] if len(sys.argv) > 1 else 'archive.db'\n    wacz_output = sys.argv[2] if len(sys.argv) > 2 else 'archive.wacz'\n    \n    create_wacz(db_path, wacz_output)\n