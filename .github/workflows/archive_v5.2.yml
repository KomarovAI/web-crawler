name: Archive v5.2 (WARC + robots.txt + media)

on:
  workflow_dispatch:
    inputs:
      url:
        description: 'Start URL (must be valid http/https URL)'
        required: true
        default: 'https://callmedley.com'
      max_pages:
        description: 'Max pages to crawl (1-5000)'
        required: true
        default: '500'
      use_selenium:
        description: 'Use Selenium for Cloudflare'
        required: false
        default: 'true'
      ignore_robots:
        description: 'Ignore robots.txt (true = crawl everything, false = respect robots.txt)'
        required: false
        default: 'false'
      target_repo:
        description: 'Target repository for deployment (format: owner/repo, leave empty to skip)'
        required: false
        default: 'KomarovAI/web-crawler-pages'
      reuse_artifact_run_id:
        description: 'Reuse artifact from previous run (leave empty to crawl now, or enter run ID)'
        required: false
        default: ''
      auto_deploy:
        description: 'Auto-deploy after crawl (true/false)'
        required: false
        default: 'true'

permissions:
  contents: read
  id-token: write
  actions: read

jobs:
  archive-and-deploy:
    name: Archive & Deploy to GitHub Pages (All-in-One)
    runs-on: ubuntu-24.04
    timeout-minutes: 120
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: requirements.txt
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Validate inputs
        id: validate
        run: |
          URL="${{ github.event.inputs.url }}"
          REUSE_RUN_ID="${{ github.event.inputs.reuse_artifact_run_id }}"
          TARGET_REPO="${{ github.event.inputs.target_repo }}"
          AUTO_DEPLOY="${{ github.event.inputs.auto_deploy }}"
          
          if [ -n "$REUSE_RUN_ID" ]; then
            echo "reuse_mode=true" >> $GITHUB_OUTPUT
            echo "reuse_run_id=$REUSE_RUN_ID" >> $GITHUB_OUTPUT
            echo "‚úÖ Reuse mode: Using artifact from run #$REUSE_RUN_ID (skip crawling)"
            exit 0
          fi
          
          echo "reuse_mode=false" >> $GITHUB_OUTPUT
          
          if [[ ! "$URL" =~ ^https?:// ]]; then
            echo "‚ùå Error: URL must start with http:// or https://"
            exit 1
          fi
          
          DOMAIN=$(echo "$URL" | sed -E 's|^https?://||' | sed -E 's|/.*||' | cut -d'?' -f1)
          MAX_PAGES="${{ github.event.inputs.max_pages }}"
          
          if ! [[ "$MAX_PAGES" =~ ^[0-9]+$ ]] || (( MAX_PAGES < 1 || MAX_PAGES > 5000 )); then
            echo "‚ùå Error: max_pages must be 1-5000"
            exit 1
          fi
          
          echo "domain=$DOMAIN" >> $GITHUB_OUTPUT
          echo "max_pages=$MAX_PAGES" >> $GITHUB_OUTPUT
          echo "target_repo=$TARGET_REPO" >> $GITHUB_OUTPUT
          echo "auto_deploy=$AUTO_DEPLOY" >> $GITHUB_OUTPUT
          echo "‚úÖ Validation passed: $DOMAIN"

      - name: Run ArchiveBot v5.2 (crawl mode)
        if: steps.validate.outputs.reuse_mode == 'false'
        run: |
          python3 << 'PYTHON'
          url = '${{ github.event.inputs.url }}'
          max_pages = '${{ steps.validate.outputs.max_pages }}'
          domain = '${{ steps.validate.outputs.domain }}'
          with open('.env', 'w') as f:
              f.write(f"STARTURL={url}\n")
              f.write(f"MAXPAGES={max_pages}\n")
          with open('domain.txt', 'w') as f:
              f.write(domain)
          PYTHON
          
          source .env
          python3 smart_archiver_v4.py "$STARTURL" "$MAXPAGES"
        env:
          USE_SELENIUM: ${{ github.event.inputs.use_selenium }}
          IGNORE_ROBOTS: ${{ github.event.inputs.ignore_robots }}

      - name: Upload archive artifact
        if: always() && steps.validate.outputs.reuse_mode == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: archive-${{ github.run_id }}
          path: archive_*/
          retention-days: 90
          compression-level: 6
          if-no-files-found: warn

      - name: Download artifact (for reuse mode)
        if: steps.validate.outputs.reuse_mode == 'true'
        uses: actions/download-artifact@v4
        with:
          name: archive-${{ steps.validate.outputs.reuse_run_id }}
          path: ./archive_reuse
          repository: KomarovAI/web-crawler
          run-id: ${{ steps.validate.outputs.reuse_run_id }}
        continue-on-error: true

      - name: Verify artifact availability
        if: steps.validate.outputs.reuse_mode == 'true'
        run: |
          if [ ! -d "./archive_reuse" ] || [ -z "$(ls -A ./archive_reuse 2>/dev/null)" ]; then
            echo "‚ùå Failed to download artifact from run #${{ steps.validate.outputs.reuse_run_id }}"
            echo ""
            echo "üìã Finding successful runs with artifacts..."
            echo ""
            gh run list --repo KomarovAI/web-crawler --status success --limit 20 | head -5
            echo ""
            echo "üîç Tip: Use the run ID (number) from the first column of a successful run"
            echo "     Example: reuse_artifact_run_id: 20330295918"
            exit 1
          fi
          echo "‚úÖ Artifact downloaded successfully"
          ls -la ./archive_reuse/
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare archive for deployment
        id: prep_archive
        run: |
          set -e
          
          # Check for archive
          if [ "${{ steps.validate.outputs.reuse_mode }}" = "true" ]; then
            ARCHIVE_DIR=$(find ./archive_reuse -maxdepth 2 -name "archive_*" -type d | head -1)
            if [ -z "$ARCHIVE_DIR" ]; then
              ls -la ./archive_reuse/
              echo "‚ùå Archive not found in reuse artifact"
              exit 1
            fi
          else
            ARCHIVE_DIR=$(find . -maxdepth 1 -name "archive_*" -type d | head -1)
            if [ -z "$ARCHIVE_DIR" ]; then
              echo "‚ùå Archive not found after crawl"
              exit 1
            fi
          fi
          
          DOMAIN=$(basename "$ARCHIVE_DIR" | sed 's/archive_//' | sed 's/_/./g')
          echo "archive_dir=$ARCHIVE_DIR" >> $GITHUB_OUTPUT
          echo "domain=$DOMAIN" >> $GITHUB_OUTPUT
          echo "‚úÖ Archive ready: $ARCHIVE_DIR"

      - name: Deploy to GitHub Pages (gh-pages)
        if: |
          github.event.inputs.target_repo != '' && (
            steps.validate.outputs.reuse_mode == 'true' || 
            (steps.validate.outputs.reuse_mode == 'false' && steps.validate.outputs.auto_deploy == 'true')
          )
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TARGET_REPO: ${{ github.event.inputs.target_repo }}
          DOMAIN: ${{ steps.prep_archive.outputs.domain }}
          ARCHIVE_DIR: ${{ steps.prep_archive.outputs.archive_dir }}
        run: |
          set -e
          
          echo "üöÄ Deploy to GitHub Pages (gh-pages)"
          echo "Target: $TARGET_REPO"
          echo "Domain: $DOMAIN"
          echo "Archive: $ARCHIVE_DIR"
          
          TEMP_DIR=$(mktemp -d)
          cd "$TEMP_DIR"
          
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          echo "üìÜ Cloning $TARGET_REPO with gh-pages branch"
          git clone --depth 1 "https://oauth2:${GH_TOKEN}@github.com/${TARGET_REPO}.git" . 2>&1 || {
            echo "üé≤ First time - creating new repo structure"
            git init
            git remote add origin "https://oauth2:${GH_TOKEN}@github.com/${TARGET_REPO}.git"
          }
          
          # Create orphan gh-pages branch
          git fetch origin gh-pages 2>/dev/null || true
          if git rev-parse --verify origin/gh-pages &>/dev/null; then
            git checkout -b gh-pages origin/gh-pages
          else
            git checkout --orphan gh-pages
          fi
          
          echo "üöõ Clean up old files"
          find . -type f ! -path './.git*' ! -name '.gitignore' -delete
          find . -type d ! -path './.git*' -empty -delete
          
          echo "üìÅ Extract archive contents"
          cp -r "$GITHUB_WORKSPACE/$ARCHIVE_DIR"/* . 2>/dev/null || true
          
          echo "üìÅ Clean up WARC files (GitHub 100MB limit)"
          find . -name "*.warc" -o -name "*.warc.gz" | xargs rm -f 2>/dev/null || true
          
          echo "üîó Rewrite URLs to local paths"
          python3 "$GITHUB_WORKSPACE/scripts/rewrite_links.py" "$DOMAIN" . 2>/dev/null || echo "‚ö†Ô∏è Rewrite skipped"
          
          # Ensure .nojekyll
          touch .nojekyll
          
          git add -A
          
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "docs: Deploy archive - $(date +'%Y-%m-%d %H:%M:%S UTC')"
            git push -u origin gh-pages --force
            echo "‚úÖ Successfully deployed to gh-pages!"
          else
            echo "‚ö†Ô∏è No changes to commit"
          fi

      - name: Create job summary
        if: always()
        run: |
          echo "## üöÄ Archive & Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Mode**: $(if [ "${{ steps.validate.outputs.reuse_mode }}" = "true" ]; then echo "Reuse (run #${{ steps.validate.outputs.reuse_run_id }})"; else echo "Crawl"; fi)" >> $GITHUB_STEP_SUMMARY
          echo "**robots.txt**: $(if [ "${{ github.event.inputs.ignore_robots }}" = "true" ]; then echo "‚õî IGNORED"; else echo "‚úÖ Respected"; fi)" >> $GITHUB_STEP_SUMMARY
          echo "**Auto-Deploy**: $(if [ "${{ steps.validate.outputs.auto_deploy }}" = "true" ]; then echo "‚úÖ Yes"; else echo "‚õî No"; fi)" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "${{ steps.prep_archive.outputs.domain }}" ]; then
            echo "**Domain**: ${{ steps.prep_archive.outputs.domain }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -n "${{ github.event.inputs.target_repo }}" ]; then
            echo "**Deployed to**: ${{ github.event.inputs.target_repo }}" >> $GITHUB_STEP_SUMMARY
            PAGES_URL="https://$(echo ${{ github.event.inputs.target_repo }} | cut -d'/' -f1).github.io/$(echo ${{ github.event.inputs.target_repo }} | cut -d'/' -f2)/"
            echo "**Pages URL**: $PAGES_URL" >> $GITHUB_STEP_SUMMARY
            echo "**Branch**: gh-pages" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚è≠Ô∏è **Deployment**: Skipped (no target_repo)" >> $GITHUB_STEP_SUMMARY
          fi
