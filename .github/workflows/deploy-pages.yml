# @description Deploys archived website to GitHub Pages gh-pages branch
# @requires download-site.yml artifact (site-archive-RUN_ID)
# @outputs GitHub Pages URL, n8n callback with deployment stats, clean gh-pages branch
# @performs Full repository reset, URL rewriting, WARC cleanup, force push

name: Deploy to GitHub Pages

on:
  workflow_dispatch:
    inputs:
      source_run_id:
        description: 'Source workflow run ID (from download-site.yml)'
        required: true
        type: string
      artifact_name:
        description: 'Artifact name to deploy (e.g. site-archive-12345)'
        required: true
        type: string
      target_repo:
        description: 'Target repository for Pages (owner/repo)'
        required: true
        type: string
        default: 'KomarovAI/archived-sites'
      clean_warc:
        description: 'Remove WARC/WARC.gz files (GitHub 100MB limit)'
        required: false
        type: boolean
        default: true
      rewrite_links:
        description: 'Rewrite URLs to local paths'
        required: false
        type: boolean
        default: true
      resumeUrl:
        description: 'n8n webhook callback URL'
        required: false
        type: string

permissions:
  contents: read
  actions: read

jobs:
  deploy-pages:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    timeout-minutes: 60

    steps:
      - name: Validate inputs
        id: validate
        run: |
          SOURCE_RUN_ID="${{ github.event.inputs.source_run_id }}"
          TARGET_REPO="${{ github.event.inputs.target_repo }}"
          ARTIFACT_NAME="${{ github.event.inputs.artifact_name }}"
          
          if [[ ! "$SOURCE_RUN_ID" =~ ^[0-9]+$ ]]; then
            echo "‚ùå Error: source_run_id must be numeric"
            exit 1
          fi
          
          if [[ ! "$TARGET_REPO" =~ ^[a-zA-Z0-9_-]+/[a-zA-Z0-9_-]+$ ]]; then
            echo "‚ùå Error: target_repo format invalid (use owner/repo)"
            exit 1
          fi
          
          if [[ -z "$ARTIFACT_NAME" ]]; then
            echo "‚ùå Error: artifact_name is required"
            exit 1
          fi
          
          echo "source_run_id=$SOURCE_RUN_ID" >> $GITHUB_OUTPUT
          echo "target_repo=$TARGET_REPO" >> $GITHUB_OUTPUT
          echo "artifact_name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT
          echo "‚úÖ Validation passed"

      - name: Download artifact from source workflow
        uses: actions/download-artifact@v4
        with:
          name: ${{ github.event.inputs.artifact_name }}
          path: ./artifact-download
          run-id: ${{ github.event.inputs.source_run_id }}

      - name: Extract and verify archive
        id: extract
        run: |
          set -e
          
          echo "üìÅ Checking downloaded artifact..."
          ls -la ./artifact-download/ | head -20
          
          # Find archive directory
          ARCHIVE_DIR=$(find ./artifact-download -maxdepth 2 -name "archive_*" -type d | head -1)
          
          if [ -z "$ARCHIVE_DIR" ]; then
            echo "‚ùå Archive directory not found"
            echo "üìÅ Directory structure:"
            find ./artifact-download -type f -o -type d | head -30
            exit 1
          fi
          
          echo "‚úÖ Found archive: $ARCHIVE_DIR"
          
          # Extract domain from archive name
          ARCHIVE_NAME=$(basename "$ARCHIVE_DIR")
          DOMAIN=$(echo "$ARCHIVE_NAME" | sed 's/archive_//' | sed 's/_/./g')
          FILE_COUNT=$(find "$ARCHIVE_DIR" -type f | wc -l)
          SIZE=$(du -sh "$ARCHIVE_DIR" | cut -f1)
          
          echo "archive_dir=$ARCHIVE_DIR" >> $GITHUB_OUTPUT
          echo "archive_name=$ARCHIVE_NAME" >> $GITHUB_OUTPUT
          echo "domain=$DOMAIN" >> $GITHUB_OUTPUT
          echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
          echo "size=$SIZE" >> $GITHUB_OUTPUT
          
          echo "‚úÖ Archive verified:"
          echo "   Domain: $DOMAIN"
          echo "   Files: $FILE_COUNT"
          echo "   Size: $SIZE"

      - name: Checkout target repository
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          
          TARGET_REPO="${{ steps.validate.outputs.target_repo }}"
          TEMP_DIR="/tmp/target-repo"
          
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          mkdir -p "$TEMP_DIR"
          cd "$TEMP_DIR"
          
          echo "üìÇ Cloning target repository: $TARGET_REPO"
          
          git clone "https://oauth2:${GH_TOKEN}@github.com/${TARGET_REPO}.git" . 2>&1 || {
            echo "‚ÑπÔ∏è  Repository doesn't exist or first deploy - initializing"
            git init
            git remote add origin "https://oauth2:${GH_TOKEN}@github.com/${TARGET_REPO}.git" 2>/dev/null || true
          }
          
          echo "‚úÖ Target repository ready"

      - name: Format and initialize gh-pages branch
        run: |
          cd /tmp/target-repo
          
          echo "üóëÔ∏è  Cleaning repository for fresh deployment"
          git rm -rf . 2>/dev/null || true
          
          echo "üìÑ Creating orphan gh-pages branch"
          git checkout --orphan gh-pages 2>/dev/null || git switch --create gh-pages 2>/dev/null || true
          
          # Ensure clean working directory
          git reset --hard HEAD 2>/dev/null || true
          rm -rf *
          
          # Create .nojekyll to skip Jekyll processing
          touch .nojekyll
          git add .nojekyll
          git commit -m "chore: Initialize gh-pages branch" --allow-empty
          
          echo "‚úÖ Repository formatted and ready"

      - name: Copy archive contents to target repo
        run: |
          set -e
          
          ARCHIVE_PATH="$GITHUB_WORKSPACE/${{ steps.extract.outputs.archive_dir }}"
          TARGET_DIR="/tmp/target-repo"
          
          echo "üìÅ Copying archive from: $ARCHIVE_PATH"
          echo "üìÅ To target directory: $TARGET_DIR"
          
          # Copy all contents (excluding git)
          find "$ARCHIVE_PATH" -maxdepth 1 -type f -exec cp {} "$TARGET_DIR/" \;
          find "$ARCHIVE_PATH" -maxdepth 1 -type d ! -name ".*" -exec cp -r {} "$TARGET_DIR/" \;
          
          echo "‚úÖ Archive contents copied"
          
          # Count final files
          FINAL_FILES=$(find "$TARGET_DIR" -type f ! -path './.git/*' | wc -l)
          FINAL_SIZE=$(du -sh "$TARGET_DIR" | cut -f1)
          
          echo "final_files=$FINAL_FILES" >> $GITHUB_OUTPUT
          echo "final_size=$FINAL_SIZE" >> $GITHUB_OUTPUT
          
          echo "üìä Final deployment:"
          echo "   Files: $FINAL_FILES"
          echo "   Size: $FINAL_SIZE"

      - name: Clean WARC files
        if: github.event.inputs.clean_warc == 'true'
        run: |
          cd /tmp/target-repo
          
          echo "üßπ Scanning for WARC files"
          WARC_COUNT=$(find . -type f \( -name "*.warc" -o -name "*.warc.gz" \) | wc -l)
          
          if [ $WARC_COUNT -gt 0 ]; then
            echo "üóëÔ∏è  Removing $WARC_COUNT WARC files"
            find . -type f \( -name "*.warc" -o -name "*.warc.gz" \) -delete
            echo "‚úÖ WARC files removed"
          else
            echo "‚úÖ No WARC files found"
          fi

      - name: Rewrite URLs to local paths
        if: github.event.inputs.rewrite_links == 'true'
        continue-on-error: true
        run: |
          cd /tmp/target-repo
          
          DOMAIN="${{ steps.extract.outputs.domain }}"
          echo "üîó Rewriting URLs for domain: $DOMAIN"
          
          python3 << 'PYTHON'
          import os
          import re
          from pathlib import Path
          
          DOMAIN = "${{ steps.extract.outputs.domain }}"
          SAFE_DOMAIN = re.escape(DOMAIN)
          
          # URL rewrite patterns
          patterns = [
              (rf'href=["\']https?://{SAFE_DOMAIN}([/a-zA-Z0-9._~:/?#@!$&\'()*+,;=%-]*)["\']',
               r'href="\1"'),
              (rf'src=["\']https?://{SAFE_DOMAIN}([/a-zA-Z0-9._~:/?#@!$&\'()*+,;=%-]*)["\']',
               r'src="\1"'),
              (rf'action=["\']https?://{SAFE_DOMAIN}([/a-zA-Z0-9._~:/?#@!$&\'()*+,;=%-]*)["\']',
               r'action="\1"'),
          ]
          
          PROCESS_EXTS = {'.html', '.htm', '.js', '.css', '.json'}
          modified = 0
          
          for root, dirs, files in os.walk('.'):
              if '.git' in dirs:
                  dirs.remove('.git')
              for file in files:
                  if Path(file).suffix.lower() in PROCESS_EXTS:
                      filepath = os.path.join(root, file)
                      try:
                          with open(filepath, 'r', encoding='utf-8', errors='ignore') as f:
                              original = f.read()
                          content = original
                          for pattern, replacement in patterns:
                              content = re.sub(pattern, replacement, content, flags=re.IGNORECASE)
                          if content != original:
                              with open(filepath, 'w', encoding='utf-8') as f:
                                  f.write(content)
                              modified += 1
                      except Exception as e:
                          pass
          
          print(f"‚úÖ Rewrote {modified} files")
          PYTHON

      - name: Commit and push to gh-pages
        id: commit
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd /tmp/target-repo
          
          echo "üìã Staging all changes"
          git add -A
          
          if git diff --cached --quiet; then
            echo "‚ÑπÔ∏è  No changes to commit"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "üìù Creating commit"
          git commit -m "chore(pages): Deploy ${{ steps.extract.outputs.domain }} (Run #${{ github.event.inputs.source_run_id }})" \
                     -m "Files: ${{ steps.extract.outputs.file_count }} | Size: ${{ steps.extract.outputs.size }}"
          
          echo "üöÄ Force pushing to gh-pages"
          git push -u origin gh-pages --force
          
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Successfully deployed"

      - name: Create summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<'EOF'
          ## ‚úÖ GitHub Pages Deployment
          
          | Property | Value |
          |----------|-------|
          | Status | ${{ job.status }} |
          | Domain | ${{ steps.extract.outputs.domain }} |
          | Files | ${{ steps.extract.outputs.file_count }} |
          | Size | ${{ steps.extract.outputs.size }} |
          | Pages URL | https://KomarovAI.github.io/archived-sites/ |
          EOF

      - name: Notify n8n on completion
        if: always() && github.event.inputs.resumeUrl != ''
        continue-on-error: true
        run: |
          RESUME_URL="${{ github.event.inputs.resumeUrl }}"
          [ -z "$RESUME_URL" ] && exit 0
          
          PAYLOAD=$(printf '{
            "status": "%s",
            "workflow": "deploy-pages",
            "run_id": %s,
            "source_run_id": %s,
            "target_repo": "%s",
            "domain": "%s",
            "original_files": "%s",
            "original_size": "%s",
            "pages_url": "https://KomarovAI.github.io/archived-sites/",
            "timestamp": "%s"
          }' "${{ job.status }}" "${{ github.run_id }}" "${{ steps.validate.outputs.source_run_id }}" "${{ steps.validate.outputs.target_repo }}" "${{ steps.extract.outputs.domain }}" "${{ steps.extract.outputs.file_count }}" "${{ steps.extract.outputs.size }}" "$(date -u +'%Y-%m-%dT%H:%M:%SZ')")
          
          curl -k -X POST "$RESUME_URL" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" \
            --retry 3 --retry-delay 5 --connect-timeout 10 --max-time 30 \
            -w "\n‚úÖ Callback sent (HTTP %{http_code})\n" || echo "‚ö†Ô∏è  Callback failed"
