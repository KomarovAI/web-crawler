name: Deploy to GitHub Pages

on:
  workflow_dispatch:
    inputs:
      artifact_source:
        description: 'Artifact source directory'
        required: true
        default: 'auto'
        type: choice
        options:
          - auto
          - public
          - docs
          - build
          - dist
          - website
      retention_days:
        description: 'Artifact retention days (1-90)'
        required: false
        default: '30'
        type: string
  push:
    branches:
      - main
    paths:
      - 'public/**'
      - 'docs/**'
      - 'build/**'
      - 'dist/**'
      - 'website/**'
      - '.github/workflows/deploy-pages.yml'

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

env:
  ARTIFACT_PATH: _site

jobs:
  prepare:
    name: Prepare Artifacts
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      artifact_id: ${{ steps.upload.outputs.artifact-id }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Prepare deployment directory
        id: prepare
        run: |
          set -e
          mkdir -p "${{ env.ARTIFACT_PATH }}"
          
          # Determine source directory
          if [ "${{ github.event_name }}" = "push" ]; then
            SOURCE="auto"
          else
            SOURCE="${{ inputs.artifact_source }}"
          fi
          
          FOUND=0
          
          if [ "$SOURCE" = "auto" ]; then
            echo "ğŸ” Auto-detecting artifact directory..."
            for dir in public docs build dist website; do
              if [ -d "$dir" ] && [ -n "$(ls -A "$dir" 2>/dev/null)" ]; then
                echo "âœ… Found content in: $dir"
                cp -r "$dir"/* "${{ env.ARTIFACT_PATH }}/"
                FOUND=1
                break
              fi
            done
          elif [ -d "$SOURCE" ] && [ -n "$(ls -A "$SOURCE" 2>/dev/null)" ]; then
            echo "âœ… Using specified source: $SOURCE"
            cp -r "$SOURCE"/* "${{ env.ARTIFACT_PATH }}/"
            FOUND=1
          fi
          
          if [ $FOUND -eq 0 ]; then
            echo "âš ï¸ No artifacts found. Creating fallback content..."
            cat > "${{ env.ARTIFACT_PATH }}/index.html" << 'FALLBACK_EOF'
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Deployment Success</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .container {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      max-width: 600px;
      text-align: center;
    }
    h1 { color: #333; margin-bottom: 0.5rem; }
    p { color: #666; line-height: 1.6; margin: 0.5rem 0; }
    .meta { background: #f5f5f5; padding: 1rem; border-radius: 4px; margin-top: 1rem; font-family: monospace; font-size: 0.85rem; }
    .status { color: #28a745; font-weight: bold; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸš€ Deployment Successful</h1>
    <p class="status">Site is live and ready to serve</p>
    <div class="meta">
      <p>Repository: ${{ github.repository }}</p>
      <p>Run: ${{ github.run_number }}</p>
      <p>Branch: ${{ github.ref_name }}</p>
    </div>
  </div>
</body>
</html>
FALLBACK_EOF
          fi

      - name: Upload Pages artifact
        id: upload
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ env.ARTIFACT_PATH }}
          retention-days: ${{ inputs.retention_days || 30 }}

  deploy:
    name: Deploy to GitHub Pages
    needs: prepare
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          artifact_id: ${{ needs.prepare.outputs.artifact_id }}

      - name: âœ… Deployment Complete
        run: |
          echo "ğŸ‰ Deployment successful!"
          echo "ğŸ“Œ Artifact ID: ${{ needs.prepare.outputs.artifact_id }}"
          echo "ğŸŒ Page URL: ${{ steps.deployment.outputs.page_url }}"
