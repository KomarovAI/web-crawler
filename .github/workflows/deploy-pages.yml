name: Deploy Website to Repository

on:
  workflow_dispatch:
    inputs:
      artifact_id:
        description: 'ID Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ğ° Ğ¸Ğ· download-site workflow (Ğ½Ğ°Ğ¹Ñ‚Ğ¸ Ğ² summary Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰ĞµĞ³Ğ¾ run)'
        required: true
        type: string
      target_repo:
        description: 'Ğ¦ĞµĞ»ĞµĞ²Ğ¾Ğ¹ Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¹ (Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚: owner/repo)'
        required: true
        type: string
      target_branch:
        description: 'Ğ¦ĞµĞ»ĞµĞ²Ğ°Ñ Ğ²ĞµÑ‚ĞºĞ° (default: main)'
        required: false
        default: 'main'
        type: string
      commit_message:
        description: 'Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğ°'
        required: false
        default: 'chore: deploy website'
        type: string

permissions:
  contents: read
  actions: read

jobs:
  deploy:
    name: Deploy Website to Target Repository
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read

    steps:
      - name: Download artifact
        id: download
        uses: actions/download-artifact@v4
        with:
          name: ${{ github.event.inputs.artifact_id }}
          path: site_content

      - name: Verify artifact
        id: verify
        run: |
          if [ ! -d "site_content" ] || [ -z "$(ls -A "site_content" 2>/dev/null)" ]; then
            echo "âŒ ĞÑ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ¸Ğ»Ğ¸ Ğ¿ÑƒÑÑ‚Ğ¾Ğ¹"
            exit 1
          fi

          FILE_COUNT=$(find site_content -type f | wc -l)
          DIR_SIZE=$(du -sh site_content | cut -f1)
          
          echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
          echo "dir_size=$DIR_SIZE" >> $GITHUB_OUTPUT
          
          echo "âœ… ĞÑ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞµĞ½: $FILE_COUNT Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² | $DIR_SIZE"
          ls -la site_content | head -20

      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.inputs.target_repo }}
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.event.inputs.target_branch }}
          fetch-depth: 1

      - name: Prepare deployment
        id: prepare
        env:
          TARGET_REPO: ${{ github.event.inputs.target_repo }}
          SOURCE_REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
        run: |
          # ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ Ğ¸ ÑĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚
          echo "ğŸ”„ Replacing repository content..."
          
          # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ²Ğ°Ğ¶Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹
          PRESERVE_FILES=(".git" ".github" ".gitignore" "README.md" "LICENSE" "CNAME")
          for file in "${PRESERVE_FILES[@]}"; do
            if [ -e "$file" ]; then
              mv "$file" "/tmp/${file##*/}.bak"
            fi
          done
          
          # Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ²ÑÑ‘ Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ
          find . -mindepth 1 -maxdepth 1 -not -name '.*' -exec rm -rf {} +
          
          # Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ²Ğ°Ğ¶Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹
          for file in "${PRESERVE_FILES[@]}"; do
            if [ -e "/tmp/${file##*/}.bak" ]; then
              mv "/tmp/${file##*/}.bak" "$file"
            fi
          done
          
          # Ğ¡ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚
          cp -r ../site_content/* .
          
          echo "source_repo=$SOURCE_REPO" >> $GITHUB_OUTPUT
          
          echo "âœ… Repository ready for commit"

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit and push
        id: commit
        env:
          COMMIT_MSG: ${{ github.event.inputs.commit_message }}
          TARGET_BRANCH: ${{ github.event.inputs.target_branch }}
          SOURCE_REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
        run: |
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ
          if git diff --quiet; then
            echo "âš ï¸ ĞĞµÑ‚ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ Ğ´Ğ»Ñ ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğ°"
            echo "status=no_changes" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ²ÑĞµ Ñ„Ğ°Ğ¹Ğ»Ñ‹
          git add -A
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğ° Ñ Ğ´ĞµÑ‚Ğ°Ğ»ÑĞ¼Ğ¸
          FULL_MSG="${COMMIT_MSG}

Source: ${SOURCE_REPO}
Run ID: ${RUN_ID}
Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
Branch: ${TARGET_BRANCH}"
          
          git commit -m "$FULL_MSG"
          git push origin "${TARGET_BRANCH}"
          
          COMMIT_SHA=$(git rev-parse HEAD)
          echo "status=success" >> $GITHUB_OUTPUT
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          
          echo "âœ… Pushed to ${{ github.event.inputs.target_repo }}"

      - name: Summary
        if: always()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š DEPLOYMENT SUMMARY"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Source Artifact ID: ${{ github.event.inputs.artifact_id }}"
          echo "Target Repository: ${{ github.event.inputs.target_repo }}"
          echo "Target Branch: ${{ github.event.inputs.target_branch }}"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "Files Deployed: ${{ steps.verify.outputs.file_count }}"
          echo "Archive Size: ${{ steps.verify.outputs.dir_size }}"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          
          if [ "${{ steps.commit.outputs.status }}" = "success" ]; then
            echo "âœ… Status: DEPLOYED SUCCESSFULLY"
            echo "Commit SHA: ${{ steps.commit.outputs.commit_sha }}"
          elif [ "${{ steps.commit.outputs.status }}" = "no_changes" ]; then
            echo "âš ï¸ Status: NO CHANGES TO DEPLOY"
          else
            echo "âŒ Status: FAILED"
          fi
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
