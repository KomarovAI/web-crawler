name: Deploy to Pages

on:
  workflow_dispatch:
    inputs:
      source_run_id:
        description: 'Source workflow run ID (from download-site)'
        required: true
        type: string
      target_repo:
        description: 'Target repository (owner/repo) for Pages deployment'
        required: true
        type: string
        default: 'KomarovAI/web-crawler-pages'
      artifact_name:
        description: 'Artifact name to download (e.g. site-archive-12345)'
        required: true
        type: string
      resumeUrl:
        description: 'n8n webhook callback URL (for dispatchAndWait)'
        required: false
        type: string
        default: ''

permissions:
  contents: read
  actions: read

jobs:
  deploy-pages:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-24.04
    
    steps:
      - name: Validate inputs
        id: validate
        run: |
          SOURCE_RUN_ID="${{ github.event.inputs.source_run_id }}"
          TARGET_REPO="${{ github.event.inputs.target_repo }}"
          ARTIFACT_NAME="${{ github.event.inputs.artifact_name }}"
          
          if [[ ! "$SOURCE_RUN_ID" =~ ^[0-9]+$ ]]; then
            echo "‚ùå Error: Invalid source_run_id (must be numeric)"
            exit 1
          fi
          
          if [[ ! "$TARGET_REPO" =~ ^[a-zA-Z0-9_-]+/[a-zA-Z0-9_-]+$ ]]; then
            echo "‚ùå Error: Invalid target_repo format (use owner/repo)"
            exit 1
          fi
          
          echo "source_run_id=$SOURCE_RUN_ID" >> $GITHUB_OUTPUT
          echo "target_repo=$TARGET_REPO" >> $GITHUB_OUTPUT
          echo "artifact_name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT
          echo "‚úÖ Validation passed"
      
      - name: Download artifact from source workflow
        uses: actions/download-artifact@v4
        with:
          name: ${{ steps.validate.outputs.artifact_name }}
          path: ./artifact-download
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ steps.validate.outputs.source_run_id }}
      
      - name: Extract and prepare archive
        id: prepare
        run: |
          cd ./artifact-download
          
          # Find archive directory
          ARCHIVE_DIR=$(find . -maxdepth 1 -name "archive_*" -type d | head -1)
          
          if [ -z "$ARCHIVE_DIR" ]; then
            echo "‚ùå Archive directory not found!"
            ls -la
            exit 1
          fi
          
          echo "archive_dir=$ARCHIVE_DIR" >> $GITHUB_OUTPUT
          echo "‚úÖ Archive found: $ARCHIVE_DIR"
          echo "üìä Contents:"
          du -sh "$ARCHIVE_DIR"
          find "$ARCHIVE_DIR" -type f | head -20
      
      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.validate.outputs.target_repo }}
          token: ${{ secrets.GITHUB_TOKEN }}
          path: ./target-repo
          fetch-depth: 0
      
      - name: Sync archive to target repo
        id: sync
        run: |
          TARGET_REPO="${{ steps.validate.outputs.target_repo }}"
          ARCHIVE_DIR="./artifact-download/${{ steps.prepare.outputs.archive_dir }}"
          
          echo "üîÑ Syncing from: $ARCHIVE_DIR"
          echo "üìÇ To: ./target-repo/"
          
          # Copy archive contents to target repo root
          cp -r "$ARCHIVE_DIR"/* ./target-repo/ || true
          
          # Count files
          FILE_COUNT=$(find ./target-repo -type f | wc -l)
          echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
          
          echo "‚úÖ Synced $FILE_COUNT files"
          
          # Show what we're deploying
          echo "üìã Top-level files:"
          ls -la ./target-repo | head -20
      
      - name: Configure Git
        run: |
          cd ./target-repo
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # Check if there are changes
          if git diff --quiet; then
            echo "‚ÑπÔ∏è  No changes detected"
            echo "has_changes=false" >> $GITHUB_ENV
          else
            echo "‚úÖ Changes detected"
            echo "has_changes=true" >> $GITHUB_ENV
          fi
      
      - name: Commit and push
        if: env.has_changes == 'true'
        run: |
          cd ./target-repo
          
          git add -A
          
          COMMIT_MSG="chore(pages): sync archived site from web-crawler (run ${{ github.run_id }})"
          git commit -m "$COMMIT_MSG" || true
          
          git push origin main || {
            echo "‚ö†Ô∏è  Push failed, checking for conflicts..."
            git pull origin main --rebase
            git push origin main
          }
          
          echo "‚úÖ Pushed to ${{ steps.validate.outputs.target_repo }}"
      
      - name: Trigger Pages build
        if: env.has_changes == 'true'
        run: |
          TARGET_REPO="${{ steps.validate.outputs.target_repo }}"
          IFS='/' read -r OWNER REPO <<< "$TARGET_REPO"
          
          echo "üöÄ Triggering Pages build for $TARGET_REPO..."
          
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$TARGET_REPO/pages/builds" \
            -d '{}' \
            -w "\n‚úÖ Build triggered (HTTP %{http_code})\n" || echo "‚ö†Ô∏è  Build trigger failed (Pages may auto-build)"
      
      - name: Create summary
        if: always()
        run: |
          echo "## ‚úÖ Pages Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Source Run** | ${{ steps.validate.outputs.source_run_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Target Repo** | ${{ steps.validate.outputs.target_repo }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Artifact** | ${{ steps.validate.outputs.artifact_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Files Deployed** | ${{ steps.sync.outputs.file_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Status** | ${{ job.status }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pages URL**: https://${{ steps.validate.outputs.target_repo }} (if enabled)" >> $GITHUB_STEP_SUMMARY
      
      - name: Notify n8n on completion
        if: always() && github.event.inputs.resumeUrl != ''
        run: |
          RESUME_URL="${{ github.event.inputs.resumeUrl }}"
          JOB_STATUS="${{ job.status }}"
          
          if [ -n "$RESUME_URL" ]; then
            echo "üì° Sending callback to n8n..."
            
            PAYLOAD=$(cat <<EOF
          {
            "status": "$JOB_STATUS",
            "conclusion": "${{ job.status }}",
            "run_id": ${{ github.run_id }},
            "workflow": "deploy-pages",
            "target_repo": "${{ steps.validate.outputs.target_repo }}",
            "files_deployed": ${{ steps.sync.outputs.file_count }},
            "timestamp": "$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          }
          EOF
            )
            
            curl -k \
              -X POST "$RESUME_URL" \
              -H "Content-Type: application/json" \
              -d "$PAYLOAD" \
              --retry 3 \
              --retry-delay 5 \
              --connect-timeout 10 \
              --max-time 30 \
              -w "\n‚úÖ Callback sent (HTTP %{http_code})\n" || echo "‚ö†Ô∏è  Callback failed (non-critical)"
          fi
