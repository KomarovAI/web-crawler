name: Deploy Static Site to GitHub Pages

on:
  workflow_dispatch:
    inputs:
      artifact_source:
        description: 'Artifact source directory'
        required: true
        default: 'auto'
        type: choice
        options:
          - auto
          - public
          - docs
          - build
          - dist
          - website
      retention_days:
        description: 'Artifact retention days (1-90)'
        required: false
        default: '30'
        type: string

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages-deploy"
  cancel-in-progress: true

env:
  ARTIFACT_PATH: _site
  ARTIFACT_RETENTION_DAYS: ${{ inputs.retention_days || 30 }}

jobs:
  prepare:
    name: Prepare Artifacts
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      artifact_id: ${{ steps.upload.outputs.artifact-id }}
      artifact_url: ${{ steps.upload.outputs.artifact-url }}
      artifact_size: ${{ steps.prepare.outputs.artifact_size }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Prepare deployment directory
        id: prepare
        run: |
          set -e
          mkdir -p "${{ env.ARTIFACT_PATH }}"
          
          SOURCE="${{ inputs.artifact_source }}"
          FOUND=0
          
          if [ "$SOURCE" = "auto" ]; then
            echo "ðŸ” Auto-detecting artifact directory..."
            for dir in public docs build dist website; do
              if [ -d "$dir" ] && [ -n "$(ls -A "$dir" 2>/dev/null)" ]; then
                echo "âœ… Found content in: $dir"
                cp -r "$dir"/* "${{ env.ARTIFACT_PATH }}/"
                FOUND=1
                break
              fi
            done
          elif [ -d "$SOURCE" ] && [ -n "$(ls -A "$SOURCE" 2>/dev/null)" ]; then
            echo "âœ… Using specified source: $SOURCE"
            cp -r "$SOURCE"/* "${{ env.ARTIFACT_PATH }}/"
            FOUND=1
          fi
          
          if [ $FOUND -eq 0 ]; then
            echo "âš ï¸  No artifacts found. Creating fallback content..."
            cat > "${{ env.ARTIFACT_PATH }}/index.html" << 'FALLBACK_EOF'
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Deployment Success</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .container {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      max-width: 600px;
      text-align: center;
    }
    h1 { color: #333; margin-bottom: 0.5rem; }
    p { color: #666; line-height: 1.6; margin: 0.5rem 0; }
    .meta { background: #f5f5f5; padding: 1rem; border-radius: 4px; margin-top: 1rem; font-family: monospace; font-size: 0.85rem; }
    .status { color: #28a745; font-weight: bold; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸš€ Deployment Successful</h1>
    <p class="status">Site is live and ready to serve</p>
    <div class="meta">
      <p>Repository: ${{ github.repository }}</p>
      <p>Run: ${{ github.run_number }}</p>
      <p>Time: $(date -u)</p>
    </div>
  </div>
</body>
</html>
FALLBACK_EOF
          fi
          
          FILE_COUNT=$(find "${{ env.ARTIFACT_PATH }}" -type f | wc -l)
          TOTAL_SIZE=$(du -sh "${{ env.ARTIFACT_PATH }}" | cut -f1)
          
          echo "ðŸ“¦ Artifact Summary:"
          echo "  Files: $FILE_COUNT"
          echo "  Size: $TOTAL_SIZE"
          echo "artifact_size=$TOTAL_SIZE" >> "$GITHUB_OUTPUT"

      - name: Upload Pages artifact
        id: upload
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ env.ARTIFACT_PATH }}
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

      - name: Log artifact details
        run: |
          echo "ðŸ“Œ Artifact Information:"
          echo "  ID: ${{ steps.upload.outputs.artifact-id }}"
          echo "  URL: ${{ steps.upload.outputs.artifact-url }}"
          echo "  Size: ${{ steps.prepare.outputs.artifact_size }}"

  deploy:
    name: Deploy to GitHub Pages
    needs: prepare
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    outputs:
      page_url: ${{ steps.deployment.outputs.page_url }}
      artifact_id: ${{ needs.prepare.outputs.artifact_id }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          artifact_id: ${{ needs.prepare.outputs.artifact_id }}

      - name: ðŸŽ‰ Deployment Summary
        run: |
          cat << 'SUMMARY_EOF'
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘                   âœ… DEPLOYMENT COMPLETE                        â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘ Repository:   ${{ github.repository }}
          â•‘ Run:          ${{ github.run_number }}
          â•‘ Artifact ID:  ${{ needs.prepare.outputs.artifact_id }}
          â•‘ Page URL:     ${{ steps.deployment.outputs.page_url }}
          â•‘ Status:       SUCCESS
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          SUMMARY_EOF