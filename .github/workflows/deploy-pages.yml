name: Deploy Website to Repository

on:
  workflow_dispatch:
    inputs:
      artifact_name:
        description: 'ÐŸÐ¾Ð»Ð½Ð¾Ðµ Ð¸Ð¼Ñ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð° (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: site_archive-20479494022)'
        required: true
        type: string
      source_run_id:
        description: 'Run ID Ð¸ÑÑ‚Ð¾Ñ‡Ð½Ð¸ÐºÐ° Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð° (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾, Ð´Ð»Ñ cross-run Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸)'
        required: false
        type: string
      target_repo:
        description: 'Ð¦ÐµÐ»ÐµÐ²Ð¾Ð¹ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ (Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚: owner/repo)'
        required: true
        type: string
      target_branch:
        description: 'Ð¦ÐµÐ»ÐµÐ²Ð°Ñ Ð²ÐµÑ‚ÐºÐ° (default: main)'
        required: false
        default: 'main'
        type: string
      commit_message:
        description: 'Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð°'
        required: false
        default: 'chore: deploy website'
        type: string

permissions:
  contents: read
  actions: read

jobs:
  deploy:
    name: Deploy Website to Target Repository
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read

    steps:
      - name: Validate inputs
        id: validate
        run: |
          echo "ðŸ” Validating inputs..."
          
          # Validate artifact name format
          ARTIFACT_NAME="${{ github.event.inputs.artifact_name }}"
          if [[ ! "$ARTIFACT_NAME" =~ ^[a-zA-Z0-9_-]+$ ]]; then
            echo "âŒ Invalid artifact name format: $ARTIFACT_NAME"
            echo "Name must contain only alphanumeric characters, dashes, and underscores"
            exit 1
          fi
          
          # Validate target repo format
          TARGET_REPO="${{ github.event.inputs.target_repo }}"
          if [[ ! "$TARGET_REPO" =~ ^[a-zA-Z0-9_-]+/[a-zA-Z0-9_-]+$ ]]; then
            echo "âŒ Invalid target repository format: $TARGET_REPO"
            echo "Format must be: owner/repo"
            exit 1
          fi
          
          echo "artifact_name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT
          echo "target_repo=$TARGET_REPO" >> $GITHUB_OUTPUT
          echo "âœ… Inputs validated successfully"
          echo "ðŸ“¦ Artifact: $ARTIFACT_NAME"
          echo "ðŸŽ¯ Target: $TARGET_REPO"

      - name: Download artifact
        id: download
        uses: actions/download-artifact@v4
        with:
          name: ${{ steps.validate.outputs.artifact_name }}
          path: site_content
          run-id: ${{ github.event.inputs.source_run_id || github.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify artifact
        id: verify
        run: |
          if [ ! -d "site_content" ] || [ -z "$(ls -A "site_content" 2>/dev/null)" ]; then
            echo "âŒ ÐÑ€Ñ‚ÐµÑ„Ð°ÐºÑ‚ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð¸Ð»Ð¸ Ð¿ÑƒÑÑ‚Ð¾Ð¹"
            echo "ðŸ“‹ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ:"
            echo "   1. ÐŸÑ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ Ð¸Ð¼ÐµÐ½Ð¸ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð°: ${{ steps.validate.outputs.artifact_name }}"
            echo "   2. Ð¡ÑƒÑ‰ÐµÑÑ‚Ð²Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð° Ð² run: ${{ github.event.inputs.source_run_id || github.run_id }}"
            echo "   3. Ð¡Ñ€Ð¾Ðº Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð° (30 Ð´Ð½ÐµÐ¹)"
            exit 1
          fi

          FILE_COUNT=$(find site_content -type f | wc -l)
          DIR_SIZE=$(du -sh site_content | cut -f1)

          echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
          echo "dir_size=$DIR_SIZE" >> $GITHUB_OUTPUT

          echo "âœ… ÐÑ€Ñ‚ÐµÑ„Ð°ÐºÑ‚ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐµÐ½: $FILE_COUNT Ñ„Ð°Ð¹Ð»Ð¾Ð² | $DIR_SIZE"
          echo "ðŸ“ Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ (Ð¿ÐµÑ€Ð²Ñ‹Ðµ 20 Ñ„Ð°Ð¹Ð»Ð¾Ð²):"
          find site_content -type f | head -20

      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.validate.outputs.target_repo }}
          token: ${{ secrets.EXTERNAL_REPO_PAT }}
          ref: ${{ github.event.inputs.target_branch }}
          fetch-depth: 1

      - name: Prepare deployment
        id: prepare
        env:
          TARGET_REPO: ${{ steps.validate.outputs.target_repo }}
          SOURCE_REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
        run: |
          echo "ðŸ”„ Replacing repository content..."

          # Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ð²Ð°Ð¶Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
          PRESERVE_FILES=(".git" ".github" ".gitignore" "README.md" "LICENSE" "CNAME")
          for file in "${PRESERVE_FILES[@]}"; do
            if [ -e "$file" ]; then
              mv "$file" "/tmp/${file##*/}.bak" 2>/dev/null || true
            fi
          done

          # Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð²ÑÑ‘ Ð¾ÑÑ‚Ð°Ð»ÑŒÐ½Ð¾Ðµ
          find . -mindepth 1 -maxdepth 1 -not -name '.*' -exec rm -rf {} + 2>/dev/null || true

          # Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð²Ð°Ð¶Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
          for file in "${PRESERVE_FILES[@]}"; do
            if [ -e "/tmp/${file##*/}.bak" ]; then
              mv "/tmp/${file##*/}.bak" "$file" 2>/dev/null || true
            fi
          done

          # Ð¡ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð½Ð¾Ð²Ñ‹Ð¹ ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚
          cp -r ../site_content/* . 2>/dev/null || true

          echo "source_repo=$SOURCE_REPO" >> $GITHUB_OUTPUT
          echo "âœ… Repository ready for commit"

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit and push
        id: commit
        env:
          COMMIT_MSG: ${{ github.event.inputs.commit_message }}
          TARGET_BRANCH: ${{ github.event.inputs.target_branch }}
          SOURCE_REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
          ARTIFACT_NAME: ${{ steps.validate.outputs.artifact_name }}
        run: |
          # ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ
          if git diff --quiet && git diff --cached --quiet; then
            echo "âš ï¸ ÐÐµÑ‚ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹ Ð´Ð»Ñ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð°"
            echo "status=no_changes" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð²ÑÐµ Ñ„Ð°Ð¹Ð»Ñ‹
          git add -A

          # Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð° Ñ Ð´ÐµÑ‚Ð°Ð»ÑÐ¼Ð¸
          FULL_MSG="${COMMIT_MSG}

Source: ${SOURCE_REPO}
Artifact: ${ARTIFACT_NAME}
Run ID: ${RUN_ID}
Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
Branch: ${TARGET_BRANCH}"

          git commit -m "$FULL_MSG"
          git push origin "${TARGET_BRANCH}"

          COMMIT_SHA=$(git rev-parse HEAD)
          echo "status=success" >> $GITHUB_OUTPUT
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT

          echo "âœ… Pushed to ${{ steps.validate.outputs.target_repo }}"
          echo "ðŸ“ Commit: $COMMIT_SHA"

      - name: Summary
        if: always()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" | tee -a $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š DEPLOYMENT SUMMARY" | tee -a $GITHUB_STEP_SUMMARY
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" | tee -a $GITHUB_STEP_SUMMARY
          echo "Source Artifact: ${{ steps.validate.outputs.artifact_name }}" | tee -a $GITHUB_STEP_SUMMARY
          echo "Source Run ID: ${{ github.event.inputs.source_run_id || github.run_id }}" | tee -a $GITHUB_STEP_SUMMARY
          echo "Target Repository: ${{ steps.validate.outputs.target_repo }}" | tee -a $GITHUB_STEP_SUMMARY
          echo "Target Branch: ${{ github.event.inputs.target_branch }}" | tee -a $GITHUB_STEP_SUMMARY
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" | tee -a $GITHUB_STEP_SUMMARY
          echo "Files Deployed: ${{ steps.verify.outputs.file_count }}" | tee -a $GITHUB_STEP_SUMMARY
          echo "Archive Size: ${{ steps.verify.outputs.dir_size }}" | tee -a $GITHUB_STEP_SUMMARY
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" | tee -a $GITHUB_STEP_SUMMARY

          if [ "${{ steps.commit.outputs.status }}" = "success" ]; then
            echo "âœ… Status: DEPLOYED SUCCESSFULLY" | tee -a $GITHUB_STEP_SUMMARY
            echo "Commit SHA: ${{ steps.commit.outputs.commit_sha }}" | tee -a $GITHUB_STEP_SUMMARY
            echo "ðŸ”— View: https://github.com/${{ steps.validate.outputs.target_repo }}/commit/${{ steps.commit.outputs.commit_sha }}" | tee -a $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.commit.outputs.status }}" = "no_changes" ]; then
            echo "âš ï¸ Status: NO CHANGES TO DEPLOY" | tee -a $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Status: FAILED" | tee -a $GITHUB_STEP_SUMMARY
          fi

          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" | tee -a $GITHUB_STEP_SUMMARY

      - name: Usage instructions
        if: success()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“– ÐšÐ°Ðº Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ ÑÑ‚Ð¾Ñ‚ workflow" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ workflow \`download-site.yml\` Ð´Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð°" >> $GITHUB_STEP_SUMMARY
          echo "2. Ð¡ÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ð¸Ð¼Ñ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð° Ð¸Ð· summary (Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚: \`site_archive-XXXXXXX\`)" >> $GITHUB_STEP_SUMMARY
          echo "3. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ ÑÑ‚Ð¾Ñ‚ workflow Ñ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð°Ð¼Ð¸:" >> $GITHUB_STEP_SUMMARY
          echo "   - **artifact_name**: Ð¿Ð¾Ð»Ð½Ð¾Ðµ Ð¸Ð¼Ñ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð°" >> $GITHUB_STEP_SUMMARY
          echo "   - **target_repo**: Ñ†ÐµÐ»ÐµÐ²Ð¾Ð¹ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ (owner/repo)" >> $GITHUB_STEP_SUMMARY
          echo "   - **target_branch**: Ñ†ÐµÐ»ÐµÐ²Ð°Ñ Ð²ÐµÑ‚ÐºÐ° (default: main)" >> $GITHUB_STEP_SUMMARY
