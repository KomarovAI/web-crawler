name: Download Site (Artifact Only)

on:
  workflow_dispatch:
    inputs:
      url:
        description: 'Start URL (http/https)'
        required: false
        type: string
        default: ''
      max_pages:
        description: 'Max pages to crawl (1-5000)'
        required: false
        type: string
        default: ''
      use_selenium:
        description: 'Use Selenium for Cloudflare'
        required: false
        type: string
        default: ''
      ignore_robots:
        description: 'Ignore robots.txt'
        required: false
        type: string
        default: ''
      target_repo:
        description: 'Target repository for upload (owner/repo)'
        required: false
        type: string
        default: ''
      auto_deploy:
        description: 'Auto deploy after download'
        required: false
        type: string
        default: ''
      reuse_artifact_run_id:
        description: 'Reuse artifact from specific run ID'
        required: false
        type: string
        default: ''
      resumeUrl:
        description: 'n8n webhook callback URL (for dispatchAndWait)'
        required: false
        type: string
        default: ''

permissions:
  contents: read
  actions: read

jobs:
  download-site:
    name: Download Site
    runs-on: ubuntu-24.04
    timeout-minutes: 120
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: requirements.txt
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Set defaults and normalize inputs
        id: normalize
        run: |
          # Set defaults if empty
          URL="${{ github.event.inputs.url }}"
          MAX_PAGES="${{ github.event.inputs.max_pages }}"
          USE_SELENIUM="${{ github.event.inputs.use_selenium }}"
          IGNORE_ROBOTS="${{ github.event.inputs.ignore_robots }}"
          AUTO_DEPLOY="${{ github.event.inputs.auto_deploy }}"
          
          # Apply defaults if empty
          URL=${URL:-"https://callmedley.com"}
          MAX_PAGES=${MAX_PAGES:-"100"}
          USE_SELENIUM=${USE_SELENIUM:-"true"}
          IGNORE_ROBOTS=${IGNORE_ROBOTS:-"false"}
          AUTO_DEPLOY=${AUTO_DEPLOY:-"false"}
          
          # Normalize boolean strings
          USE_SELENIUM=$(echo "$USE_SELENIUM" | tr '[:upper:]' '[:lower:]')
          IGNORE_ROBOTS=$(echo "$IGNORE_ROBOTS" | tr '[:upper:]' '[:lower:]')
          AUTO_DEPLOY=$(echo "$AUTO_DEPLOY" | tr '[:upper:]' '[:lower:]')
          
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "max_pages=$MAX_PAGES" >> $GITHUB_OUTPUT
          echo "use_selenium=$USE_SELENIUM" >> $GITHUB_OUTPUT
          echo "ignore_robots=$IGNORE_ROBOTS" >> $GITHUB_OUTPUT
          echo "auto_deploy=$AUTO_DEPLOY" >> $GITHUB_OUTPUT
          echo "‚úÖ Inputs normalized"
      
      - name: Validate inputs
        id: validate
        run: |
          URL="${{ steps.normalize.outputs.url }}"
          MAX_PAGES="${{ steps.normalize.outputs.max_pages }}"
          
          # Validate URL
          if [[ ! "$URL" =~ ^https?:// ]]; then
            echo "‚ùå Error: URL must start with http:// or https://"
            exit 1
          fi
          
          # Validate max_pages (convert to int)
          MAX_PAGES_INT=${MAX_PAGES//[^0-9]/}
          if ! [[ "$MAX_PAGES_INT" =~ ^[0-9]+$ ]] || (( MAX_PAGES_INT < 1 || MAX_PAGES_INT > 5000 )); then
            echo "‚ùå Error: max_pages must be 1-5000, got: $MAX_PAGES"
            exit 1
          fi
          
          # Extract domain
          DOMAIN=$(echo "$URL" | sed -E 's|^https?://||' | sed -E 's|/.*||' | cut -d'?' -f1)
          
          echo "domain=$DOMAIN" >> $GITHUB_OUTPUT
          echo "max_pages_int=$MAX_PAGES_INT" >> $GITHUB_OUTPUT
          echo "‚úÖ Validation passed: $DOMAIN (max_pages: $MAX_PAGES_INT)"
      
      - name: Download site with smart_archiver_v4.py
        run: |
          python3 << 'PYTHON'
          url = '${{ steps.normalize.outputs.url }}'
          max_pages = '${{ steps.validate.outputs.max_pages_int }}'
          domain = '${{ steps.validate.outputs.domain }}'
          
          with open('.env', 'w') as f:
              f.write(f"STARTURL={url}\n")
              f.write(f"MAXPAGES={max_pages}\n")
          
          with open('domain.txt', 'w') as f:
              f.write(domain)
          
          print(f"‚úÖ Configuration written:")
          print(f"   URL: {url}")
          print(f"   Max Pages: {max_pages}")
          print(f"   Domain: {domain}")
          PYTHON
          
          source .env
          python3 smart_archiver_v4.py "$STARTURL" "$MAXPAGES"
        env:
          USE_SELENIUM: ${{ steps.normalize.outputs.use_selenium }}
          IGNORE_ROBOTS: ${{ steps.normalize.outputs.ignore_robots }}
      
      - name: Verify archive
        run: |
          ARCHIVE_DIR=$(find . -maxdepth 1 -name "archive_*" -type d | head -1)
          if [ -z "$ARCHIVE_DIR" ]; then
            echo "‚ùå Archive not found!"
            exit 1
          fi
          
          echo "‚úÖ Archive found: $ARCHIVE_DIR"
          echo "üìä Archive contents:"
          du -sh "$ARCHIVE_DIR"
          find "$ARCHIVE_DIR" -type f | head -20
      
      - name: Upload archive artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: site-archive-${{ github.run_id }}
          path: archive_*/
          retention-days: 90
          compression-level: 6
          if-no-files-found: warn
      
      - name: Create summary
        if: always()
        run: |
          echo "## ‚úÖ Site Download Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **URL** | ${{ steps.normalize.outputs.url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Max Pages** | ${{ steps.validate.outputs.max_pages_int }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Domain** | ${{ steps.validate.outputs.domain }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Selenium** | ${{ steps.normalize.outputs.use_selenium }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Ignore robots.txt** | ${{ steps.normalize.outputs.ignore_robots }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Auto Deploy** | ${{ steps.normalize.outputs.auto_deploy }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Artifact Name**: site-archive-${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Retention**: 90 days" >> $GITHUB_STEP_SUMMARY
      
      - name: Notify n8n on completion (with SSL bypass)
        if: always() && github.event.inputs.resumeUrl != ''
        run: |
          RESUME_URL="${{ github.event.inputs.resumeUrl }}"
          JOB_STATUS="${{ job.status }}"
          RUN_ID="${{ github.run_id }}"
          DOMAIN="${{ steps.validate.outputs.domain }}"
          
          if [ -n "$RESUME_URL" ]; then
            echo "üì° Sending callback to n8n..."
            
            PAYLOAD=$(cat <<EOF
          {
            "status": "$JOB_STATUS",
            "conclusion": "${{ job.status }}",
            "run_id": $RUN_ID,
            "workflow": "download-site",
            "domain": "$DOMAIN",
            "max_pages": "${{ steps.validate.outputs.max_pages_int }}",
            "artifact_name": "site-archive-${{ github.run_id }}",
            "timestamp": "$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          }
          EOF
            )
            
            curl -k \
              -X POST "$RESUME_URL" \
              -H "Content-Type: application/json" \
              -d "$PAYLOAD" \
              --retry 3 \
              --retry-delay 5 \
              --connect-timeout 10 \
              --max-time 30 \
              -w "\n‚úÖ Callback sent (HTTP %{http_code})\n" || echo "‚ö†Ô∏è  Callback failed (non-critical)"
          fi
