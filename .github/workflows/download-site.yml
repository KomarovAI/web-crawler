name: Download Website Archive

on:
  workflow_dispatch:
    inputs:
      url:
        description: 'Website URL to download (e.g., https://example.com)'
        required: false
        default: 'https://callmedley.com'
        type: string
      depth_level:
        description: 'Crawl depth: 1=homepage, 2=+children (default), 3=+grandchildren, 4=very deep'
        required: false
        default: '2'
        type: string
      output_dir:
        description: 'Output directory name (no special chars)'
        required: false
        default: 'site_archive'
        type: string
      resumeUrl:
        description: 'N8N webhook URL for callback (auto-filled by N8N)'
        required: false
        type: string

jobs:
  download:
    name: Download Website Archive
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      actions: read

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: main

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget
          pip install requests beautifulsoup4 selenium

      - name: Validate inputs
        id: validate
        env:
          INPUT_URL: ${{ github.event.inputs.url || 'https://callmedley.com' }}
          INPUT_DEPTH: ${{ github.event.inputs.depth_level || '2' }}
          INPUT_OUTPUT: ${{ github.event.inputs.output_dir || 'site_archive' }}
        run: |
          echo ""
          echo "üìã Parsed inputs:"
          echo "   URL: $INPUT_URL"
          echo "   Output Dir: $INPUT_OUTPUT"
          echo "   Depth Level: $INPUT_DEPTH"
          echo ""

          # Validate URL
          if [[ ! "$INPUT_URL" =~ ^https?:// ]]; then
            echo "‚ùå ERROR: URL must start with http:// or https://"
            echo "Got: $INPUT_URL"
            exit 1
          fi

          # Validate depth_level (CRITICAL)
          if ! [[ "$INPUT_DEPTH" =~ ^[0-9]+$ ]]; then
            echo "‚ùå ERROR: depth_level must be numeric, got \"$INPUT_DEPTH\""
            exit 1
          fi

          if (( INPUT_DEPTH < 1 )) || (( INPUT_DEPTH > 4 )); then
            echo "‚ùå ERROR: depth_level must be 1-4, got $INPUT_DEPTH"
            echo ""
            echo "Levels:"
            echo "  1 = Start page only (fastest)"
            echo "  2 = Start + direct children (recommended)"
            echo "  3 = Start + 2 levels deep"
            echo "  4 = Very deep crawl (be careful!)"
            exit 1
          fi

          # Get level description
          case $INPUT_DEPTH in
            1) LEVEL_DESC="Start page only (fastest)" ;;
            2) LEVEL_DESC="Start + direct children (recommended)" ;;
            3) LEVEL_DESC="Start + 2 levels deep" ;;
            4) LEVEL_DESC="Very deep crawl (slow, be careful!)" ;;
          esac

          # Sanitize directory name
          SANITIZED_DIR=$(echo "$INPUT_OUTPUT" | tr -cd '[:alnum:]_-')
          if [ -z "$SANITIZED_DIR" ]; then
            SANITIZED_DIR="site_archive"
          fi

          # Output for next steps
          echo "output_dir=$SANITIZED_DIR" >> $GITHUB_OUTPUT
          echo "url=$INPUT_URL" >> $GITHUB_OUTPUT
          echo "depth_level=$INPUT_DEPTH" >> $GITHUB_OUTPUT
          echo "level_description=$LEVEL_DESC" >> $GITHUB_OUTPUT

          echo "‚úÖ Validation PASSED"
          echo "   URL: $INPUT_URL"
          echo "   Output Dir: $SANITIZED_DIR"
          echo "   Depth Level: $INPUT_DEPTH ($LEVEL_DESC)"

      - name: Download site with wget
        id: download
        env:
          URL: ${{ steps.validate.outputs.url }}
          OUTPUT_DIR: ${{ steps.validate.outputs.output_dir }}
          DEPTH: ${{ steps.validate.outputs.depth_level }}
        run: |
          echo ""
          echo "üåê Starting site download..."
          echo "   URL: $URL"
          echo "   Depth Level: $DEPTH"
          echo "   Output Dir: $OUTPUT_DIR"
          echo ""

          # Create output directory
          mkdir -p "$OUTPUT_DIR"

          # Download with wget
          # -r = recursive, -l = level depth, -k = convert links, -p = page requisites
          # -E = add .html extension, --no-parent = don't go up directory
          wget \
            --recursive \
            --level="$DEPTH" \
            --convert-links \
            --page-requisites \
            --adjust-extension \
            --no-parent \
            --directory-prefix="$OUTPUT_DIR" \
            --continue \
            --timeout=30 \
            --tries=3 \
            --user-agent="Mozilla/5.0 (X11; Linux x86_64)" \
            "$URL" || true  # Don't fail on wget errors

          echo "‚úÖ Download completed (or partially completed)"

      - name: Verify archive
        id: verify
        env:
          OUTPUT_DIR: ${{ steps.validate.outputs.output_dir }}
        run: |
          echo ""
          echo "üîç Verifying archive at: $OUTPUT_DIR"

          if [ ! -d "$OUTPUT_DIR" ]; then
            echo "‚ùå ERROR: Output directory not found"
            exit 1
          fi

          if [ -z "$(ls -A "$OUTPUT_DIR" 2>/dev/null)" ]; then
            echo "‚ö†Ô∏è WARNING: Output directory is empty"
            echo "Listing $OUTPUT_DIR:"
            ls -la "$OUTPUT_DIR"
            exit 1
          fi

          FILE_COUNT=$(find "$OUTPUT_DIR" -type f | wc -l)
          DIR_SIZE=$(du -sh "$OUTPUT_DIR" | cut -f1)

          echo "‚úÖ Archive verified:"
          echo "   Files: $FILE_COUNT"
          echo "   Size: $DIR_SIZE"
          echo ""

          echo "upload_path=$OUTPUT_DIR" >> $GITHUB_OUTPUT
          echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
          echo "dir_size=$DIR_SIZE" >> $GITHUB_OUTPUT

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ${{ steps.validate.outputs.output_dir }}-${{ github.run_id }}
          path: ${{ steps.verify.outputs.upload_path }}
          retention-days: 30
          if-no-files-found: warn

      - name: Send callback to N8N
        if: always()
        env:
          RESUME_URL: ${{ github.event.inputs.resumeUrl }}
          FILE_COUNT: ${{ steps.verify.outputs.file_count || '0' }}
          DIR_SIZE: ${{ steps.verify.outputs.dir_size || '0' }}
          URL: ${{ steps.validate.outputs.url }}
          DEPTH_LEVEL: ${{ steps.validate.outputs.depth_level }}
          RUN_ID: ${{ github.run_id }}
          STATUS: ${{ job.status }}
        run: |
          echo ""
          echo "üì° Sending callback to N8N..."
          echo "   Resume URL: $RESUME_URL"
          echo "   Status: $STATUS"
          echo "   Files: $FILE_COUNT"
          echo "   Size: $DIR_SIZE"
          echo ""

          if [ -z "$RESUME_URL" ] || [ "$RESUME_URL" == "" ]; then
            echo "‚ö†Ô∏è No resume URL provided, skipping callback"
            exit 0
          fi

          # Send callback with curl
          curl -X POST "$RESUME_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"status\": \"$STATUS\",
              \"files_count\": $FILE_COUNT,
              \"archive_size\": \"$DIR_SIZE\",
              \"url\": \"$URL\",
              \"depth_level\": $DEPTH_LEVEL,
              \"run_id\": \"$RUN_ID\"
            }" \
            -v || echo "‚ö†Ô∏è Failed to send callback, but workflow completed"

      - name: Create summary
        if: always()
        env:
          URL: ${{ steps.validate.outputs.url }}
          DEPTH: ${{ steps.validate.outputs.depth_level }}
          DESC: ${{ steps.validate.outputs.level_description }}
          FILE_COUNT: ${{ steps.verify.outputs.file_count || 'N/A' }}
          DIR_SIZE: ${{ steps.verify.outputs.dir_size || 'N/A' }}
          STATUS: ${{ job.status }}
        run: |
          echo "## ‚úÖ Download Site Workflow" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Key | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **URL** | $URL |" >> $GITHUB_STEP_SUMMARY
          echo "| **Depth Level** | $DEPTH - $DESC |" >> $GITHUB_STEP_SUMMARY
          echo "| **Files Downloaded** | $FILE_COUNT |" >> $GITHUB_STEP_SUMMARY
          echo "| **Archive Size** | $DIR_SIZE |" >> $GITHUB_STEP_SUMMARY
          echo "| **Status** | $STATUS |" >> $GITHUB_STEP_SUMMARY
