name: üï∑Ô∏è Crawl

on:
  workflow_dispatch:
    inputs:
      sites_json:
        description: 'JSON: [{"url":"https://example.com","max_pages":50}]'
        required: true
        default: '[{"url":"https://callmedley.com","max_pages":500}]'

jobs:
  crawl:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    strategy:
      matrix:
        site: ${{ fromJson(github.event.inputs.sites_json) }}
      max-parallel: 3
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install deps
        run: pip install -r requirements.txt
      
      - name: Setup site
        id: site
        env:
          SITE_JSON: ${{ toJson(matrix.site) }}
        run: |
          python3 << 'PYTHON'
          import json
          import os
          
          site = json.loads(os.environ['SITE_JSON'])
          url = site['url']
          max_pages = site.get('max_pages', 50)
          domain = url.replace('https://', '').replace('http://', '').split('/')[0].replace('.', '_')
          
          with open('.env', 'w') as f:
            f.write(f"START_URL={url}\n")
            f.write(f"MAX_PAGES={max_pages}\n")
            f.write(f"DB_FILE={domain}.db\n")
          
          with open('domain.txt', 'w') as f:
            f.write(domain)
          PYTHON
          
          domain=$(cat domain.txt)
          echo "domain=${domain}" >> $GITHUB_OUTPUT
          echo "db_file=${domain}.db" >> $GITHUB_OUTPUT
      
      - name: üï∑Ô∏è Run crawler
        run: python crawler.py
      
      - name: üì¶ Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: db-${{ steps.site.outputs.domain }}
          path: ${{ steps.site.outputs.db_file }}
          retention-days: 90
          if-no-files-found: error
          compression-level: 0

  verify:
    needs: crawl
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: üì• Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: üêç Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: üîç COMPREHENSIVE VERIFICATION
        run: |
          python3 << 'VERIFY_EOF'
          import sqlite3
          import json
          from pathlib import Path
          import sys
          
          print("\n" + "="*120)
          print("üîç COMPREHENSIVE DATABASE VERIFICATION (8 CATEGORIES)")
          print("="*120)
          
          artifacts_dir = Path('artifacts')
          db_files = list(artifacts_dir.glob('db-*/*.db'))
          
          if not db_files:
              print("\n‚ùå No database files found!")
              sys.exit(1)
          
          print(f"\nüì¶ Processing {len(db_files)} database(s)\n")
          
          for db_file in sorted(db_files):
              domain = db_file.parent.name.replace('db-', '')
              file_size_mb = db_file.stat().st_size / 1024 / 1024
              
              print(f"\n{'='*120}")
              print(f"üóÇÔ∏è  {domain.upper()} | {file_size_mb:.2f} MB")
              print(f"{'='*120}")
              
              conn = sqlite3.connect(str(db_file))
              conn.row_factory = sqlite3.Row
              cursor = conn.cursor()
              
              print("\n1Ô∏è‚É£  DATABASE INTEGRITY + FOREIGN KEYS")
              cursor.execute("PRAGMA integrity_check")
              integrity = cursor.fetchone()[0]
              test1 = integrity == 'ok'
              print(f"   {'‚úÖ' if test1 else '‚ùå'} integrity_check: {integrity}")
              
              cursor.execute("PRAGMA quick_check")
              quick = cursor.fetchone()[0]
              print(f"   ‚úÖ quick_check: {quick}")
              
              cursor.execute("PRAGMA foreign_key_check")
              fk_errors = cursor.fetchall()
              test_fk = len(fk_errors) == 0
              print(f"   {'‚úÖ' if test_fk else '‚ùå'} Foreign keys: {len(fk_errors)} violations")
              
              print("\n2Ô∏è‚É£  PAGES VALIDATION")
              cursor.execute("SELECT COUNT(*) FROM pages")
              pages_total = cursor.fetchone()[0]
              cursor.execute("SELECT COUNT(DISTINCT url) FROM pages")
              unique_urls = cursor.fetchone()[0]
              cursor.execute("SELECT COUNT(*) FROM pages WHERE status_code = 200")
              pages_200 = cursor.fetchone()[0]
              print(f"   ‚úÖ Total pages: {pages_total}")
              print(f"   ‚úÖ Unique URLs: {unique_urls}")
              print(f"   ‚úÖ Status 200 OK: {pages_200}/{pages_total}")
              
              print("\n3Ô∏è‚É£  ASSETS INTEGRITY")
              cursor.execute("SELECT COUNT(*) FROM assets")
              assets_total = cursor.fetchone()[0]
              cursor.execute("SELECT COUNT(*) FROM assets WHERE content_hash IS NULL")
              assets_no_hash = cursor.fetchone()[0]
              test3a = assets_no_hash == 0
              print(f"   {'‚úÖ' if test3a else '‚ùå'} Assets with content_hash: {assets_total - assets_no_hash}/{assets_total}")
              
              print("\n4Ô∏è‚É£  ASSET BLOBs VERIFICATION")
              cursor.execute("SELECT COUNT(*) FROM asset_blobs")
              blobs_total = cursor.fetchone()[0]
              cursor.execute("SELECT COUNT(*) FROM asset_blobs WHERE content IS NULL")
              blobs_no_content = cursor.fetchone()[0]
              test4a = blobs_no_content == 0
              print(f"   {'‚úÖ' if test4a else '‚ùå'} BLOBs with content: {blobs_total - blobs_no_content}/{blobs_total}")
              
              print("\n5Ô∏è‚É£  DEDUPLICATION STATS")
              cursor.execute("SELECT COUNT(DISTINCT content_hash) FROM assets")
              unique_blobs = cursor.fetchone()[0]
              dedup_pct = ((assets_total - unique_blobs) / assets_total * 100) if assets_total > 0 else 0
              print(f"   ‚úÖ Total assets: {assets_total}")
              print(f"   ‚úÖ Unique: {unique_blobs} ({dedup_pct:.1f}% deduplicated)")
              
              print("\n6Ô∏è‚É£  MIME-TYPES")
              cursor.execute("SELECT asset_type, COUNT(*) FROM assets GROUP BY asset_type ORDER BY COUNT(*) DESC LIMIT 5")
              for atype, cnt in cursor.fetchall():
                  print(f"   ‚Ä¢ {atype}: {cnt}")
              
              print("\n7Ô∏è‚É£  PERFORMANCE METRICS")
              cursor.execute("PRAGMA page_count")
              page_count = cursor.fetchone()[0]
              cursor.execute("PRAGMA page_size")
              page_size = cursor.fetchone()[0]
              print(f"   ‚úÖ Pages: {page_count}, Size: {page_size} bytes")
              
              print("\n8Ô∏è‚É£  FINAL VERDICT")
              if integrity == 'ok' and test1 and test_fk and test3a and test4a:
                  print(f"   üåü ALL TESTS PASSED - PRODUCTION READY ‚úÖ")
              else:
                  print(f"   ‚ö†Ô∏è  SOME TESTS FAILED")
                  sys.exit(1)
              
              conn.close()
          
          print("\n‚úÖ VERIFICATION COMPLETE!\n")
          VERIFY_EOF
