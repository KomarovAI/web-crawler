name: üï∑Ô∏è Crawl

on:
  workflow_dispatch:
    inputs:
      sites_json:
        description: 'JSON array: [{"url":"https://example.com","max_pages":50}]'
        required: true
        default: '[{"url":"https://example.com","max_pages":50}]'

jobs:
  crawl:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      matrix:
        site: ${{ fromJson(github.event.inputs.sites_json) }}
      max-parallel: 3
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install deps
        run: pip install -r requirements.txt
      
      - name: Setup site
        id: site
        run: |
          python << 'EOF'
          import json
          site = json.loads('${{ toJson(matrix.site) }}')
          url = site['url']
          max_pages = site.get('max_pages', 50)
          domain = url.replace('https://', '').replace('http://', '').split('/')[0].replace('.', '_')
          db_file = f"{domain}.db"
          
          print(f"\nüï∑Ô∏è Crawling: {url}")
          print(f"Max pages: {max_pages}")
          print(f"DB file: {db_file}\n")
          
          with open('.env', 'w') as f:
            f.write(f"START_URL={url}\n")
            f.write(f"MAX_PAGES={max_pages}\n")
            f.write(f"DB_FILE={db_file}\n")
          EOF
          
          domain=$(python3 -c "import json; site=json.loads('${{ toJson(matrix.site) }}'); url=site['url']; print(url.replace('https://', '').replace('http://', '').split('/')[0].replace('.', '_'))")
          echo "domain=${domain}" >> $GITHUB_OUTPUT
          echo "db_file=${domain}.db" >> $GITHUB_OUTPUT
      
      - name: Run crawler
        run: python crawler.py
      
      - name: Check DB
        run: |
          if [ -f "${{ steps.site.outputs.db_file }}" ]; then
            ls -lh ${{ steps.site.outputs.db_file }}
            sqlite3 ${{ steps.site.outputs.db_file }} "SELECT COUNT(*) FROM pages"
          fi
      
      - name: Upload to artifacts (90 days)
        uses: actions/upload-artifact@v4
        with:
          name: databases
          path: ${{ steps.site.outputs.db_file }}
          retention-days: 90
      
      - name: Create release with DB (permanent)
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ steps.site.outputs.db_file }}
          tag_name: crawl-${{ github.run_number }}-${{ steps.site.outputs.domain }}
          body: '‚úÖ Crawled: ${{ matrix.site.url }}'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
