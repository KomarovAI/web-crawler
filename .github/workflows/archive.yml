name: Archive Website

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      site_json:
        description: 'Site JSON config'
        required: true
        default: '{"url": "https://callmedley.com", "maxPages": 500}'

jobs:
  archive:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/cache@v3
        with:
          path: .cache/pip
          key: pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: pip-
      
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: requirements.txt
      
      - run: pip install -r requirements.txt
      
      - name: Extract site config
        run: |
          python3 << 'PYTHON'
          import json
          import os
          
          site = json.loads(os.environ['SITE_JSON'])
          url = site['url']
          maxpages = site.get('maxPages', 500)
          domain = url.replace('https:', '').replace('http:', '').replace('//', '').split('/')[0].replace('.', '')
          
          with open('.env', 'w') as f:
            f.write(f'START_URL={url}\n')
            f.write(f'MAX_PAGES={maxpages}\n')
          
          with open('domain.txt', 'w') as f:
            f.write(domain)
          
          print(f'CONFIG: url={url}, maxpages={maxpages}, domain={domain}')
          PYTHON
        env:
          SITE_JSON: ${{ github.event.inputs.site_json || '{"url": "https://callmedley.com", "maxPages": 500}' }}
      
      - name: Run archiver v4
        run: |
          cat .env
          source .env
          echo "ðŸš€ Starting ArchiveBot v4"
          echo "URL: $START_URL"
          echo "MAX_PAGES: $MAX_PAGES"
          echo "TIMEOUT: 60s (improved from 30s)"
          echo "RETRIES: 3 attempts with exponential backoff"
          echo "DEPTH: 6 levels (improved from 4)"
          python3 smart_archiver_v4.py "$START_URL" "$MAX_PAGES"
          echo "status=$?" >> $GITHUB_OUTPUT
        id: archiver
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: archive-$(cat domain.txt)
          path: archive_$(cat domain.txt)/
          retention-days: 90
      
      - name: Summary
        run: |
          DOMAIN=$(cat domain.txt)
          echo "## âœ… Archive Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### v4 Improvements" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Timeout: 30s â†’ **60s**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Retries: **3 attempts** with exponential backoff" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… MAX_DEPTH: 4 â†’ **6 levels**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… URL Normalization: removes ?page=1" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Intelligent BFS: Services > Locations > Blog" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ Artifact: archive_$DOMAIN" >> $GITHUB_STEP_SUMMARY
          echo "â±ï¸ Status: $([ ${{ steps.archiver.outputs.status }} -eq 0 ] && echo 'SUCCESS âœ…' || echo 'FAILED âŒ')" >> $GITHUB_STEP_SUMMARY
