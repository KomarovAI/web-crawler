name: Dispatch Download

on:
  workflow_dispatch:
    inputs:
      url:
        description: 'Website URL'
        required: false
        default: 'https://callmedley.com'
        type: string
      depth_level:
        description: 'Depth: 1-4'
        required: false
        default: '2'
        type: string
      output_dir:
        description: 'Output dir'
        required: false
        default: 'site_archive'
        type: string
      resumeUrl:
        description: 'N8N callback URL'
        required: false
        type: string

jobs:
  download:
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      actions: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - run: |
          sudo apt-get update -qq && sudo apt-get install -y -qq wget
          pip install -q requests beautifulsoup4 selenium
      - id: validate
        env:
          URL: ${{ github.event.inputs.url }}
          DEPTH: ${{ github.event.inputs.depth_level }}
          OUTPUT: ${{ github.event.inputs.output_dir }}
        run: |
          [[ "$URL" =~ ^https?:// ]] || { echo "Bad URL"; exit 1; }
          [[ "$DEPTH" =~ ^[1-4]$ ]] || { echo "Bad depth"; exit 1; }
          echo "output_dir=${OUTPUT:-site_archive}" >> $GITHUB_OUTPUT
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "depth=$DEPTH" >> $GITHUB_OUTPUT
      - id: download
        env:
          URL: ${{ steps.validate.outputs.url }}
          DEPTH: ${{ steps.validate.outputs.depth }}
          OUTPUT: ${{ steps.validate.outputs.output_dir }}
        run: |
          mkdir -p "$OUTPUT"
          wget -q --recursive --level="$DEPTH" --convert-links --page-requisites \
            --adjust-extension --no-parent --directory-prefix="$OUTPUT" \
            --timeout=30 --tries=3 --user-agent="Mozilla/5.0" "$URL" || true
      - id: verify
        env:
          OUTPUT: ${{ steps.validate.outputs.output_dir }}
        run: |
          [ ! -d "$OUTPUT" ] && { echo "No output"; exit 1; }
          COUNT=$(find "$OUTPUT" -type f | wc -l)
          SIZE=$(du -sh "$OUTPUT" | cut -f1)
          echo "count=$COUNT" >> $GITHUB_OUTPUT
          echo "size=$SIZE" >> $GITHUB_OUTPUT
          echo "path=$OUTPUT" >> $GITHUB_OUTPUT
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ${{ steps.validate.outputs.output_dir }}-${{ github.run_id }}
          path: ${{ steps.verify.outputs.path }}
          retention-days: 30
          if-no-files-found: warn
      - if: always() && github.event.inputs.resumeUrl
        run: |
          curl -s -X POST "${{ github.event.inputs.resumeUrl }}" \
            -H "Content-Type: application/json" \
            -d '{
              "status": "${{ job.status }}",
              "files": ${{ steps.verify.outputs.count || 0 }},
              "size": "${{ steps.verify.outputs.size }}",
              "url": "${{ steps.validate.outputs.url }}",
              "depth": ${{ steps.validate.outputs.depth }},
              "run_id": "${{ github.run_id }}"
            }' || true
