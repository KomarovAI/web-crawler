name: ğŸ” Database Integrity & Performance Audit

on:
  workflow_run:
    workflows: ["Web Crawler"]
    types: [completed]
  schedule:
    - cron: '0 */6 * * *'  # ĞšĞ°Ğ¶Ğ´Ñ‹Ğµ 6 Ñ‡Ğ°ÑĞ¾Ğ²
  workflow_dispatch:

jobs:
  audit:
    runs-on: ubuntu-latest
    name: Full Database Audit
    
    steps:
      - name: ğŸ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ’¾ Download database artifact
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: false
          run-id: ${{ github.event.workflow_run.id }}
        continue-on-error: true
      
      - name: ğŸ  Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: ğŸ” Run comprehensive database audit
        run: |
          if [ -d "artifacts" ]; then
            echo "ğŸ“‹ Running comprehensive database audit..."
            python3 DATABASE_AUDIT_DETAILED.py
          else
            echo "âš ï¸  No artifacts found, skipping audit"
            exit 0
          fi
      
      - name: ğŸ“ˆ Generate audit report
        if: always()
        run: |
          python3 << 'EOF'
          import sqlite3
          from pathlib import Path
          
          artifacts_dir = Path('artifacts')
          db_files = list(artifacts_dir.glob('db-*/*.db'))
          
          if not db_files:
              print("âŒ No databases to report")
              exit(1)
          
          print("
### ğŸ“‹ Database Audit Report")
          print()
          
          for db_file in sorted(db_files):
              domain = db_file.parent.name.replace('db-', '')
              conn = sqlite3.connect(str(db_file))
              cursor = conn.cursor()
              
              print(f"#### {domain}")
              
              # Pages
              cursor.execute("SELECT COUNT(*) FROM pages")
              pages = cursor.fetchone()[0]
              print(f"- ğŸ“„ Pages: {pages}")
              
              # Assets
              cursor.execute("SELECT COUNT(*) FROM assets")
              assets = cursor.fetchone()[0]
              cursor.execute("SELECT COUNT(DISTINCT content_hash) FROM assets")
              unique_assets = cursor.fetchone()[0]
              dedup = ((assets - unique_assets) / assets * 100) if assets > 0 else 0
              print(f"- ğŸ“‚ Assets: {assets} ({unique_assets} unique, {dedup:.1f}% deduplicated)")
              
              # Size
              print(f"- ğŸ“Š Size: {db_file.stat().st_size / 1024 / 1024:.2f} MB")
              
              # Integrity
              cursor.execute("PRAGMA integrity_check")
              integrity = cursor.fetchone()[0]
              status = "âœ…" if integrity == 'ok' else "âŒ"
              print(f"- {status} Integrity: {integrity}")
              
              conn.close()
              print()
          
          EOF
          
        continue-on-error: true
      
      - name: ğŸ“„ Create job summary
        if: always()
        run: |
          echo "# ğŸ” Database Integrity Audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Status**: Audit completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Checks Performed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Database integrity (PRAGMA integrity_check)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Schema validation" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Tables structure" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Assets completeness" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… BLOB deduplication" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Foreign key constraints" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Orphaned records detection" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Database performance metrics" >> $GITHUB_STEP_SUMMARY
